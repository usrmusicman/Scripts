#!/bin/sh

## Make sure to have pacman.conf in the same directory as Archlinux_Installer before executing this script.

## Distribution Name
DISTRO_NAME="Archlinux"

# Which device to install boot EFI on. Use 'blkid' command to get device name. (i.e. /dev/sda)
INSTALL_DEVICE=""
# Which partition is used for boot images. Use 'blkid' command to get device partition number. (i.e. 1, 2, 3, etc...)
BOOT_PARTNUM=""
# Which partition is used for OS installation. Use 'blkid' command to get device partition number (i.e. 1, 2, 3, etc...)
OS_PARTNUM=""
# Mountpoint for install. (i.e. /mnt)
MOUNT_DIR=""

# Computer and User Credentials
HOSTNAME=""
USERNAME=""
PASSWORD=""

# Keymap to use. Use the command 'localectl list-keymaps' to find your keyboard type (i.e. us)
KEYMAP=""
# System Locale/Language. Use the command 'cat /etc/locale.gen'. (i.e. en_US.UTF-8)
LOCALE=""
# Your Timezone. Use the command 'timedatectl list-timezones' to find your timezone. (i.e. America/Toronto)
TIMEZONE=""

# Do you want to format the partition type 'true' if you do, else the system will not be formatted. (default is true)
FORMAT_DEVICE="true"

# Do you want a gaming install type 'true' if you do, else gaming packages won't be installed. (default is true)
GAMING="true"

## Detect CPU and GPU. DON'T TOUCH THESE COMMANDS.
DETECT_CPU=`cat /proc/cpuinfo | tr -d " " | head -10 | grep vendor_id | cut -d : -f 2`
DETECT_GPU=`lspci | grep VGA | cut -d ":" -f 3 | cut -d " " -f 2`


#<-- OS Install List -->

## Install KDE Plasma desktop
INSTALL_OS="alsa-card-profiles alsa-firmware alsa-lib alsa-plugins alsa-topology-conf alsa-ucm-conf alsa-utils apparmor appmenu-gtk-module archlinux-appstream-data argyllcms aribb24 aribb25 ark audiocd-kio base base-devel bash-completion bluedevil bluez bluez-cups bluez-hid2hci bluez-libs bluez-plugins bluez-qt bluez-utils btrfs-progs cdparanoia cdrdao cdrtools chmlib chromium clang crda cups cups-filters cups-pdf darktable dcraw dolphin dolphin-plugins dosfstools dvd+rw-tools e2fsprogs easy-rsa ebook-tools elisa emovix espeak-ng espeak-ng-espeak exfatprogs extra-cmake-modules fatresize ffmpeg ffmpegthumbs firewalld fwupd fwupd-efi git gnu-free-fonts gnuplot gst-libav gst-plugin-opencv gst-plugin-pipewire gst-plugins-bad gst-plugins-bad-libs gst-plugins-base gst-plugins-base-libs gst-plugins-espeak gst-plugins-good gst-plugins-ugly gstreamer-vaapi gwenview handbrake helvum hunspell hunspell-en_au hunspell-en_ca hunspell-en_gb hunspell-en_us hyphen hyphen-en k3b kaccounts-providers kamera kate kcalc kcm-wacomtablet kde-cli-tools kdeconnect kdegraphics-mobipocket kdegraphics-thumbnailers kdenlive kdialog keepassxc kf5 kf5-aids kio-extras kio-gdrive kipi-plugins konsole konversation krita krita-plugin-gmic kseexpr kwalletmanager lensfun libappimage libcurl-compat libcurl-gnutls libdbusmenu-gtk2 libdbusmenu-gtk3 libdbusmenu-qt5 libdbusmenu-qt6 libdvdcss libdvdnav libdvdread libindicator-gtk2 libindicator-gtk3 libmypaint libmythes libpipewire02 linux-firmware linux-zen linux-zen-headers lrzip lsb-release lzop man-db man-pages mythes-en multilib-devel net-tools networkmanager networkmanager-openvpn noto-fonts noto-fonts-cjk noto-fonts-emoji noto-fonts-extra ntfs-3g obs-studio okteta okular opencolorio opencv openssh opentimelineio orca p7zip packagekit-qt5 partitionmanager perl-image-exiftool phonon-qt5-gstreamer phonon-qt5-vlc pipewire pipewire-alsa pipewire-jack pipewire-pulse pipewire-v4l2 pipewire-x11-bell pipewire-zeroconf plasma poppler-data poppler-qt5 portmidi print-manager pulsemixer python-lsp-server qbittorrent qt5-imageformats qt5-multimedia qt5-wayland qt6-wayland quota-tools realtime-privileges reflector rtirq rust skanlite sndio soundkonverter source-highlight sox spectacle speech-dispatcher sshfs subversion sudo texlab traceroute transcode ttf-dejavu ttf-liberation unace unarchiver unrar unzip usbguard vcdimager vdpauinfo vim vim-runtime vlc wget wireplumber xdg-user-dirs-gtk xf86-input-libinput xsettingsd youtube-dl yt-dlp zip zram-generator"

## Gaming Related Packages
INSTALL_GAMING="gamemode gamescope lib32-gamemode lib32-gst-plugins-base lib32-gst-plugins-good lib32-libxslt lib32-pipewire-jack lib32-pipewire-v4l2 lib32-v4l-utils lib32-vkd3d steam steam-native-runtime wine wine-gecko wine-mono winetricks vkd3d"

#<-- GPU Driver Install List -->

## AMD GPU DRIVERS
AMD_DRV="amf-headers lib32-libva-mesa-driver lib32-ocl-icd lib32-opencl-mesa lib32-vulkan-mesa-layers lib32-vulkan-radeon libva-mesa-driver ocl-icd opencl-clhpp opencl-headers opencl-mesa vulkan-radeon vulkan-mesa-layers"

## INTEL GPU DRIVERS
INTEL_DRV="intel-compute-runtime intel-media-driver intel-media-sdk lib32-libva-intel-driver lib32-libva-mesa-driver lib32-ocl-icd lib32-vulkan-intel lib32-vulkan-mesa-layers libva-intel-driver libva-mesa-driver ocl-icd opencl-clhpp opencl-headers vulkan-intel vulkan-mesa-layers"

## NVIDIA GPU DRIVERS
NVIDIA_DRV="lib32-libva-vdpau-driver lib32-nvidia-cg-toolkit lib32-nvidia-utils lib32-ocl-icd lib32-opencl-nvidia lib32-vulkan-mesa-layers libva-vdpau-driver libvdpau-va-gl nvidia-cg-toolkit nvidia-dkms nvidia-settings nvidia-utils ocl-icd opencl-clhpp opencl-headers opencl-nvidia vulkan-mesa-layers"

##<-- Install System, DO NOT EDIT BELOW THIS POINT IF YOU DON'T KNOW WHAT YOU'RE DOING! -->

##<-- System Install Options -->
install_os() {
    ## Label BTRFS root partition
    btrfs filesystem label ${INSTALL_DEVICE}${OS_PARTNUM} "${DISTRO_NAME}"

    ## Mount root filesystem
    mount -t btrfs ${INSTALL_DEVICE}${OS_PARTNUM} $MOUNT_DIR

    ## Remove BTRFS subvolumes if they exist
    if [[ -d "$MOUNT_DIR/@" ]]; then
        rm -rf $MOUNT_DIR/@
    fi
    if [[ -d "$MOUNT_DIR/@cache" ]]; then
        rm -rf $MOUNT_DIR/@cache
    fi
    if [[ -d "$MOUNT_DIR/@log" ]]; then
        rm -rf $MOUNT_DIR/@log
    fi
    if [[ -d "$MOUNT_DIR/@snapshots" ]]; then
        rm -rf $MOUNT_DIR/@snapshots
    fi

    ## Create BTRFS subvolumes
    btrfs subvolume create $MOUNT_DIR/@
    btrfs subvolume create $MOUNT_DIR/@cache
    btrfs subvolume create $MOUNT_DIR/@home
    btrfs subvolume create $MOUNT_DIR/@log
    btrfs subvolume create $MOUNT_DIR/@snapshots

    ## Unmount root filesystem
    umount $MOUNT_DIR
    echo "Created Subvolumes..." && sleep 5

    ## Mount root subvolume (Please use an SSD as this works best for BTRFS)
    mount -t btrfs -o noatime,compress=zstd:3,discard=async,space_cache=v2,autodefrag,subvol=@ ${INSTALL_DEVICE}${OS_PARTNUM} $MOUNT_DIR

    ## Make directories for other subvolumes
    mkdir -p $MOUNT_DIR/{.snapshots,home,var/cache,var/log}

    ## Mount other subvolumes (Please use an SSD as this works best for BTRFS)
    mount -t btrfs -o noatime,compress=zstd:3,discard=async,space_cache=v2,autodefrag,subvol=@cache ${INSTALL_DEVICE}${OS_PARTNUM} $MOUNT_DIR/var/cache
    mount -t btrfs -o noatime,compress=zstd:3,discard=async,space_cache=v2,autodefrag,subvol=@home ${INSTALL_DEVICE}${OS_PARTNUM} $MOUNT_DIR/home
    mount -t btrfs -o noatime,compress=zstd:3,discard=async,space_cache=v2,autodefrag,subvol=@log ${INSTALL_DEVICE}${OS_PARTNUM} $MOUNT_DIR/var/log
    mount -t btrfs -o noatime,compress=zstd:3,discard=async,space_cache=v2,autodefrag,subvol=@snapshots ${INSTALL_DEVICE}${OS_PARTNUM} $MOUNT_DIR/.snapshots

    ## Make efi directory
    mkdir -p $MOUNT_DIR/boot

    ## Mount the efi partition
    mount ${INSTALL_DEVICE}${BOOT_PARTNUM} $MOUNT_DIR/boot
    echo "Mounted Partitions and Subvolumes..." && sleep 5

    ## Initialize pacman-keyring (host)
    pacman -Syy --noconfirm archlinux-keyring
    pacman-key --init
    pacman-key --populate

    ## Install pacman.conf
    install -Dm644 pacman.conf $MOUNT_DIR/etc/pacman.conf

    ## Install base packages
    pacstrap $MOUNT_DIR $INSTALL_OS

    ## Generate filesystem mounts
    genfstab -U $MOUNT_DIR > $MOUNT_DIR/etc/fstab

    ## Install the display drivers
    if [[ "$DETECT_GPU" == "Advanced" ]]; then
        ## Install AMD GPU drivers
        arch-chroot $MOUNT_DIR pacman -S --noconfirm $AMD_DRV
        echo "Installed AMD Drivers..." && sleep 5
    elif [[ "$DETECT_GPU" == "Intel" ]]; then
        ## Install Intel GPU drivers
        arch-chroot $MOUNT_DIR pacman -S --noconfirm $INTEL_DRV
        echo "Installed Intel Drivers..." && sleep 5
    elif [[ "$DETECT_GPU" == "NVIDIA" ]]; then
        ## Install Nvidia GPU drivers
        arch-chroot $MOUNT_DIR pacman -S --noconfirm $NVIDIA_DRV
        ## Enable Nvidia related services
        arch-chroot $MOUNT_DIR systemctl enable nvidia-hibernate
        arch-chroot $MOUNT_DIR systemctl enable nvidia-persistenced
        arch-chroot $MOUNT_DIR systemctl enable nvidia-resume
        arch-chroot $MOUNT_DIR systemctl enable nvidia-suspend
        ## Enable early loading of Nvidia drivers
        sed -i -e "s/MODULES=()/MODULES=(nvidia nvidia_modeset nvidia_uvm nvidia_drm)/" $MOUNT_DIR/etc/mkinitcpio.conf
        echo "Installed Nvidia Drivers..." && sleep 5
    fi

    ## Install CPU firmware and create boot entry
    if [[ "$DETECT_CPU" == "AuthenticAMD" ]]; then
        ## Install AMD CPU Firmware
        arch-chroot $MOUNT_DIR pacman -S --noconfirm amd-ucode
        efibootmgr --disk $INSTALL_DEVICE --part $BOOT_PARTNUM --create --label "Arch Linux" --loader /vmlinuz-linux-zen --unicode "root=LABEL=${DISTRO_NAME} resume=LABEL=${DISTRO_NAME} rootflags=subvol=@ loglevel=3 lsm=landlock,lockdown,yama,apparmor,bpf mitigations=off nvidia-drm.modeset=1 threadirqs rw initrd=\amd-ucode.img initrd=\initramfs-linux-zen.img"
    elif [[ "$DETECT_CPU" == "GenuineIntel" ]]; then
        ## Install Intel CPU Firmware
        arch-chroot $MOUNT_DIR pacman -S --noconfirm intel-ucode
        efibootmgr --disk $INSTALL_DEVICE --part $BOOT_PARTNUM --create --label "Arch Linux" --loader /vmlinuz-linux-zen --unicode "root=LABEL=${DISTRO_NAME} resume=LABEL=${DISTRO_NAME} rootflags=subvol=@ loglevel=3 lsm=landlock,lockdown,yama,apparmor,bpf mitigations=off nvidia-drm.modeset=1 threadirqs rw initrd=\intel-ucode.img initrd=\initramfs-linux-zen.img"
    fi

    ## Install Gaming Related Packages
    if [[ "$GAMING" == "true" ]]; then
        arch-chroot $MOUNT_DIR pacman -S --noconfirm $INSTALL_GAMING
    fi

    ## Install ZRAM Configure
    echo "[zram0]" > $MOUNT_DIR/etc/systemd/zram-generator.conf
    echo "host-memory-limit = none" >> $MOUNT_DIR/etc/systemd/zram-generator.conf
    echo "zram-size = min(ram / 2, 8192)" >> $MOUNT_DIR/etc/systemd/zram-generator.conf
    echo "compression-algorithm = zstd" >> $MOUNT_DIR/etc/systemd/zram-generator.conf
    echo "options = discard" >> $MOUNT_DIR/etc/systemd/zram-generator.conf
    echo "swap-priority=32767" >> $MOUNT_DIR/etc/systemd/zram-generator.conf

    ## Install Kernel Tweaks
    echo "vm.swappiness = 10" > $MOUNT_DIR/etc/sysctl.d/90-swappiness.conf
    echo "fs.inotify.max_user_watches = 600000" > $MOUNT_DIR/etc/sysctl.d/90-max_user_watches.conf

    ## Set Disk I/O Udev Rules
    echo "ACTION==\"add|change\", KERNEL==\"nvme[0-9]n[0-9]\", ATTR{queue/scheduler}=\"none\"" > $MOUNT_DIR/etc/udev/rules.d/60-ioschedulers.rules
    echo "ACTION==\"add|change\", KERNEL==\"sd[a-z]*|mmcblk[0-9]*\", ATTR{queue/rotational}==\"0\", ATTR{queue/scheduler}=\"mq-deadline\"" >> $MOUNT_DIR/etc/udev/rules.d/60-ioschedulers.rules
    echo "ACTION==\"add|change\", KERNEL==\"sd[a-z]*\", ATTR{queue/rotational}==\"1\", ATTR{queue/scheduler}=\"bfq\"" >> $MOUNT_DIR/etc/udev/rules.d/60-ioschedulers.rules

    ## Set hostname
    echo "$HOSTNAME" > $MOUNT_DIR/etc/hostname

    ## Configure global environment for use with TTY CLI
    echo "EDITOR=/usr/bin/vim" >> $MOUNT_DIR/etc/environment

    ## Set system language
    echo "LANG=$LOCALE" > $MOUNT_DIR/etc/locale.conf
    sed -i -e "s/#$LOCALE/$LOCALE/" $MOUNT_DIR/etc/locale.gen
    arch-chroot $MOUNT_DIR locale-gen
    arch-chroot $MOUNT_DIR localectl set-locale LANG=$LOCALE

    ## Set keyboard layout
    arch-chroot $MOUNT_DIR localectl set-keymap $KEYMAP
    arch-chroot $MOUNT_DIR localectl set-x11-keymap $KEYMAP

    ## Set timezone and correct time
    arch-chroot $MOUNT_DIR ln -sf /usr/share/zoneinfo/$TIMEZONE /etc/localtime

    ## Create the new non-root user
    arch-chroot $MOUNT_DIR useradd -m $USERNAME

    ## Set password for the new user
    echo "$USERNAME:$PASSWORD" | arch-chroot $MOUNT_DIR chpasswd

    ## Enable the wheel group root privileges
    sed -i -e 's/# %wheel ALL=(ALL:ALL) ALL/%wheel ALL=(ALL:ALL) ALL/' $MOUNT_DIR/etc/sudoers

    ## Enable Plasma desktop services
    arch-chroot $MOUNT_DIR systemctl enable apparmor.service
    arch-chroot $MOUNT_DIR systemctl enable avahi-daemon.service
    arch-chroot $MOUNT_DIR systemctl enable avahi-dnsconfd.service
    arch-chroot $MOUNT_DIR systemctl enable bluetooth.service
    arch-chroot $MOUNT_DIR systemctl enable cups.service
    arch-chroot $MOUNT_DIR systemctl enable cups-browsed.service
    arch-chroot $MOUNT_DIR systemctl enable fstrim.timer
    arch-chroot $MOUNT_DIR systemctl enable NetworkManager.service
    arch-chroot $MOUNT_DIR systemctl enable rtirq.service
    arch-chroot $MOUNT_DIR systemctl enable rtirq-resume.service
    arch-chroot $MOUNT_DIR systemctl enable sddm.service

    ## Add user to groups
    arch-chroot $MOUNT_DIR usermod -a -G audio $USERNAME
    arch-chroot $MOUNT_DIR usermod -a -G flatpak $USERNAME
    arch-chroot $MOUNT_DIR usermod -a -G games $USERNAME
    arch-chroot $MOUNT_DIR usermod -a -G realtime $USERNAME
    arch-chroot $MOUNT_DIR usermod -a -G video $USERNAME
    arch-chroot $MOUNT_DIR usermod -a -G wheel $USERNAME
    echo "Installed Archlinux OS..." && sleep 5
}

##<-- Partition Drives -->
partition_system() {
    ## Create A BTRFS root partition
    mkfs.btrfs -f ${INSTALL_DEVICE}${OS_PARTNUM}

    ## Create A UEFI Boot Partition
    mkfs.vfat -F32 ${INSTALL_DEVICE}${BOOT_PARTNUM}
    echo "Formatted Partitions..." && sleep 5
}

##<-- Unmount OS -->
unmount_os() {
    ## Unmount Filesystems
    umount -lf $MOUNT_DIR
}

#<-- Main Program UNCOMMENT TO ACTIVATE --> ############
if [[ $USER == "root" ]]; then
    if [[ $FORMAT_DEVICE == "true" ]]; then
        partition_system
    fi
    install_os
    unmount_os
fi
